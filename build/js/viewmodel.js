var ViewModel=function(locations,markerTypes,map){var self=this;var locations=locations||[];var markerTypes=markerTypes||[];var bouncingMarker={};this.map=map;this.temporaryLocation=ko.observable(new Location({}));this.selectedLocation=ko.observable(new Location({}));this.filter=ko.observable("");this.addMarker=function(){if(self.temporaryLocation().name().trim().length==0){self.temporaryLocation().name("no name")}self.temporaryLocation().googleMarker().$infobox.addClass("infobox-hide");self.temporaryLocation().googleMarker().parent=self.temporaryLocation();self.locations.push(self.temporaryLocation().googleMarker().parent);self.temporaryLocation(new Location({}))};this.removeMarker=function(){self.selectedLocation().googleMarker().$infobox.addClass("infobox-hide");self.selectedLocation().googleMarker().setMap(null);self.locations.remove(self.selectedLocation())};this.hideInfobox=function(){self.selectedLocation().googleMarker().$infobox.addClass("infobox-hide")};this.mapClick=function(map,event){var lat=event.latLng.lat();var lng=event.latLng.lng();self.addMarkerToView(map,self.temporaryLocation(),lat,lng);console.log("Lat="+lat+"; Lng="+lng)};this.addMarkerToView=function(map,location,lat,lng){if(!$.isEmptyObject(location.googleMarker())){self.temporaryLocation().googleMarker().setMap(null)}var pinImage="images/pin_small.png";location.lat(lat);location.lng(lng);var marker=new google.maps.Marker({position:new google.maps.LatLng(lat,lng),map:map,icon:location.type().url(),title:location.name(),animation:google.maps.Animation.DROP});location.googleMarker(marker);marker.$infobox=$(".infobox-inner");marker.$infobox.addClass("infobox-hide");var myOptions={content:marker.$infobox[0],disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(-170,-180),zIndex:null,infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};marker.ib=new InfoBox(myOptions);google.maps.event.addListener(marker,"click",function(event){self.selectMarker(marker)})};this.selectMarker=function(marker){marker.$infobox.removeClass("infobox-hide");self.selectedLocation(marker.parent||self.temporaryLocation());marker.ib.open(map,marker);if(marker.getAnimation()!=null&&marker!=bouncingMarker){marker.setAnimation(null)}else{if(bouncingMarker.setAnimation){bouncingMarker.setAnimation(null)}marker.setAnimation(google.maps.Animation.BOUNCE);bouncingMarker=marker}};this.setTypeSelectedLocation=function(markerType){self.selectedLocation().type(markerType);self.selectedLocation().googleMarker().setIcon(markerType.url())};this.selectLocation=function(location){self.selectMarker(location.googleMarker())};this.filterKeyPress=function(model,event){self.filter(self.filter()+String.fromCharCode(event.keyCode));self.filterLocations(self.filter())};this.filterKeyEvent=function(model,event){self.filterLocations(self.filter())};this.filterLocations=function(text){text=text||"";text=text.toLowerCase();if(self.selectedLocation().googleMarker().$infobox){self.selectedLocation().googleMarker().$infobox.addClass("infobox-hide")}self.locations().forEach(function(location){if(location.name().toLowerCase().indexOf(text)>-1){location.isVisible(true);location.googleMarker().setMap(self.map)}else{location.isVisible(false);location.googleMarker().setMap(null)}})};this.filterLocationsByType=function(type){if(self.selectedLocation().googleMarker().$infobox){self.selectedLocation().googleMarker().$infobox.addClass("infobox-hide")}self.locations().forEach(function(location){if(type.title()==markerTypes.none.title()||location.type().title()==type.title()){location.isVisible(true);location.googleMarker().setMap(self.map)}else{location.isVisible(false);location.googleMarker().setMap(null)}})};this.markerTypes=ko.observableArray(Object.keys(markerTypes).map(function(key){return markerTypes[key]}));this.locations=ko.observableArray(locations.map(function(location){self.addMarkerToView(self.map,location,location.lat(),location.lng());location.googleMarker().parent=location;return location}));this.getListOfPlacesGoogle=function(markerType,googleType){function callback(results,status){if(status==google.maps.places.PlacesServiceStatus.OK){for(var i=0;i<results.length;i++){var place=results[i];var location=new Location({name:results[i].name,lat:results[i].geometry.location.k,lng:results[i].geometry.location.D,type:markerType});self.addMarkerToView(self.map,location,location.lat(),location.lng());location.googleMarker().parent=location;self.locations.push(location)}}}var locationCoordinates=new google.maps.LatLng(52.2375111,21.0111977);var request={location:locationCoordinates,radius:"3000",types:[googleType]};service=new google.maps.places.PlacesService(map);service.nearbySearch(request,callback)};this.getListOfPlacesGoogle(markerTypes.restaurant,"restaurant");this.getListOfPlacesGoogle(markerTypes.bar,"bar");this.getListOfPlacesGoogle(markerTypes.coffee,"cafe");this.getListOfPlacesGoogle(markerTypes.movies,"movie_theater");this.getListOfPlacesGoogle(markerTypes.diving,"aquarium")};