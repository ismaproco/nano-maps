var ViewModel=function(locations,markerTypes,map){var self=this;var locations=locations||[];var markerTypes=markerTypes||[];this.markerTypes=ko.observableArray(Object.keys(markerTypes).map(function(key){return markerTypes[key]}));this.map=map;this.currentLocation=ko.observable(new Location({}));this.selectedLocation=ko.observable(new Location({}));this.addMarker=function(){self.currentLocation().googleMarker().$infobox.addClass("infobox-hide");self.currentLocation().googleMarker().parent=self.currentLocation();self.locations.push(self.currentLocation().googleMarker().parent);self.currentLocation(new Location({}))};this.removeMarker=function(){self.selectedLocation().googleMarker().$infobox.addClass("infobox-hide");self.selectedLocation().googleMarker().setMap(null);self.locations.remove(self.selectedLocation())};this.mapClick=function(map,event){var lat=event.latLng.lat();var lng=event.latLng.lng();self.addMarkerToView(map,self.currentLocation(),lat,lng);console.log("Lat="+lat+"; Lng="+lng)};this.setTypeSelectedLocation=function(markerType){self.selectedLocation().type(markerType);self.selectedLocation().googleMarker().setIcon(markerType.url())};this.writeLog=function(text){console.log(text)};this.addMarkerToView=function(map,location,lat,lng){if(!$.isEmptyObject(location.googleMarker())){self.currentLocation().googleMarker().setMap(null)}var pinImage="images/pin_small.png";location.lat(lat);location.lng(lng);var marker=new google.maps.Marker({position:new google.maps.LatLng(lat,lng),map:map,icon:location.type().url(),title:location.name()});location.googleMarker(marker);marker.$infobox=$(".infobox-inner");marker.$infobox.addClass("infobox-hide");var myOptions={content:marker.$infobox[0],disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(-170,-180),zIndex:null,infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};var ib=new InfoBox(myOptions);google.maps.event.addListener(marker,"click",function(event){marker.$infobox.removeClass("infobox-hide");self.selectedLocation(marker.parent||self.currentLocation());ib.open(map,marker)})};this.locations=ko.observableArray(locations.map(function(location){self.addMarkerToView(self.map,location,location.lat(),location.lng());location.googleMarker().parent=location;return location}));this.LocationsFiltered=ko.computed(function(){return this.locations().filter(function(location){return location})},this)};